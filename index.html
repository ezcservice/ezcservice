<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>EzCwebApp</title>

<style>
*{box-sizing:border-box;}

body{
    margin:0;
    font-family:system-ui, Arial;
    background:#eaeef3;
}

.app{
    max-width:420px;
    margin:auto;
    min-height:100vh;
    background:#fff;
}

/* PAGES */
.page{
    padding:16px;
}

h3{text-align:center;}

label{
    display:block;
    margin-top:14px;
    font-weight:600;
}

input{
    width:100%;
    padding:14px;
    margin-top:6px;
    border-radius:12px;
    border:1px solid #ccc;
    font-size:16px;
}

button{
    width:100%;
    padding:14px;
    margin-top:14px;
    border:none;
    border-radius:14px;
    font-size:16px;
    color:#fff;
    background:#27ae60;
}

.clear-btn{background:#e74c3c;}
.pay-btn{background:#2980b9;}

canvas{
    width:100%;
    height:160px;
    border:2px dashed #aaa;
    border-radius:12px;
    margin-top:8px;
    touch-action:none;
}

/* STATEMENTS */
.statement{
    margin-top:12px;
    padding:12px;
    background:#f4f6f8;
    border-radius:12px;
    font-size:14px;
    line-height:1.5;
}

/* LOADING */
#loading{
    position:fixed;
    inset:0;
    background:rgba(255,255,255,.95);
    display:none;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:999;
}

.spinner{
    width:48px;
    height:48px;
    border:5px solid #6dd5fa;
    border-top:5px solid #27ae60;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-bottom:20px;
}

@keyframes spin{
    100%{transform:rotate(360deg);}
}

.loading-text{
    text-align:center;
    font-size:15px;
    padding:0 20px;
}

#page2{display:none;}
</style>
</head>

<body>
<div class="app">

<!-- PAGE 1 -->
<div class="page" id="page1">
    <h3>Customer Details</h3>

    <label>Name</label>
    <input id="name">

    <label>NIC</label>
    <input id="nic">

    <label>Amount (Rs)</label>
    <input type="number" id="amount">

    <div class="statement">
        මා විසින් ලබාගන්නා මෙම මුදල, ඉහත ලේඛනයේ සඳහන් පොලී අනුපාතයන්ට එකඟව මුදල් ගෙවන බවට මෙයින් පොරොන්දු වෙමි.
    </div>

    <label>Signature</label>
    <canvas id="sign"></canvas>
    <button class="clear-btn" onclick="clearSign()">Clear Signature</button>

    <button onclick="goNext()">Next</button>
</div>

<!-- PAGE 2 -->
<div class="page" id="page2">
    <h3>Loan Approved</h3>

    <p><b>Requested Amount:</b> Rs. <span id="showAmount"></span></p>
    <p><b>Insurance Payment:</b> Rs. <span id="insurance"></span></p>

    <div class="statement">
        ඔබ ලබාගන්නා ණය මුදල අනුමත වී ඇත.<br><br>
        එම මුදල ලබා ගැනීම සඳහා, ඉහත සඳහන් රක්ෂණ මුදල ගෙවීම අනිවාර්ය වේ.<br><br>
        රක්ෂණ මුදල ගෙවා පැයක් ඇතුළත, අපගේ පද්ධතිය මඟින් ඔබගේ ගිණුමට මුදල් බැර කරනු ලැබේ.<br><br>
        අප විසින් ලබාදෙන රිසිට් පත WhatsApp හරහා එවනු ලැබේ.
    </div>

    <label>Upload Receipt</label>
    <input type="file" id="receipt" accept="image/*">

    <button onclick="submitForm()">Submit</button>

    <p style="margin-top:15px"><b>Loan Release:</b> Within 1 Hour</p>

    <button class="pay-btn" id="payNowBtn">Pay Now</button>
</div>

</div>

<!-- LOADING PAGE -->
<div id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">
        Please waiting...<br>
        (ණය ලබා ගැනීමට මේ විස්තර verify කරමින් පවතී)
    </div>
</div>

<script>
/* CONFIG */
const PAY_LINK = "https://example.com/pay";
const WHATSAPP_NO = "94742089009";

/* INSURANCE CALCULATION */
function calculateInsurance(amount){
    amount = parseInt(amount);
    if(amount<=30000) return 2000;
    if(amount<=40000) return 2500;
    if(amount<=50000) return 3000;
    if(amount<=100000) return 3500;
    if(amount<=200000) return 4000;
    if(amount<=300000) return 4000;
    if(amount<=400000) return 5000;
    return 5500;
}

/* SIGNATURE */
const c = document.getElementById("sign");
const ctx = c.getContext("2d");
ctx.lineWidth = 3;
ctx.lineCap = "round";

function resizeCanvas(){
    const ratio = window.devicePixelRatio || 1;
    c.width = c.offsetWidth * ratio;
    c.height = c.offsetHeight * ratio;
    ctx.setTransform(ratio,0,0,ratio,0,0);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

let drawing = false;
c.addEventListener("pointerdown", e => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
c.addEventListener("pointermove", e => { if(!drawing) return; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); });
c.addEventListener("pointerup", ()=>drawing=false);
c.addEventListener("pointerleave", ()=>drawing=false);

/* Touch fallback */
c.addEventListener("touchstart", e => {
    const t = e.touches[0];
    drawing = true;
    ctx.beginPath();
    ctx.moveTo(t.clientX - c.getBoundingClientRect().left, t.clientY - c.getBoundingClientRect().top);
});
c.addEventListener("touchmove", e => {
    if(!drawing) return;
    const t = e.touches[0];
    ctx.lineTo(t.clientX - c.getBoundingClientRect().left, t.clientY - c.getBoundingClientRect().top);
    ctx.stroke();
});
c.addEventListener("touchend", ()=>drawing=false);

function clearSign(){ ctx.clearRect(0,0,c.width,c.height); }

/* PAGE 1 -> LOADING -> PAGE 2 */
function goNext(){
    const name = document.getElementById("name").value.trim();
    const nic = document.getElementById("nic").value.trim();
    const amount = document.getElementById("amount").value;

    if(!name || !nic || !amount){
        alert("කරුණාකර සියලු fields පුරවන්න");
        return;
    }

    const insurance = calculateInsurance(amount);
    document.getElementById("showAmount").innerText = amount;
    document.getElementById("insurance").innerText = insurance;

    document.getElementById("page1").style.display = "none";
    document.getElementById("loading").style.display = "flex";

    setTimeout(()=>{
        document.getElementById("loadingText").innerHTML=
        "ණය ලබා ගැනීමට මේ විස්තර ටික complete කරන්න";
    },4000);

    setTimeout(()=>{
        document.getElementById("loading").style.display = "none";
        document.getElementById("page2").style.display = "block";
    },7000);
}

/* SUBMIT */
function submitForm(){
    const receipt = document.getElementById("receipt");
    const payBtn = document.getElementById("payNowBtn");

    if(receipt.files.length===0){
        alert("කරුණාකර receipt upload කරන්න");
        return;
    }

    const now = new Date();
    const checkTime = new Date(now.getTime() + 10*60000);
    const loanRelease = new Date(now.getTime() + 60*60000);

    const msg = `Receipt Uploaded ✅
Check Time: ${checkTime.toLocaleTimeString()}
Loan Release: ${loanRelease.toLocaleTimeString()}`;

    window.open(
        "https://wa.me/"+WHATSAPP_NO+"?text="+encodeURIComponent(msg),
        "_blank"
    );

    payBtn.disabled = false;
    payBtn.onclick = () => { window.location.href = PAY_LINK; };

    alert("Receipt uploaded successfully. දැන් Pay Now click කරන්න.");
}
</script>
</body>
</html>
